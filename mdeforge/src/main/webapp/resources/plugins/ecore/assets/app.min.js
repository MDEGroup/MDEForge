/*! ecore-online-editor 2013-06-30 */
function handleFileSelect(e){e.stopPropagation(),e.preventDefault(),e.target.getAttribute("data-startbyte"),e.target.getAttribute("data-endbyte");var t=e.dataTransfer.files,i=t[0],n=new FileReader;n.onloadend=function(e){if(e.target.readyState==FileReader.DONE){var t=e.target.result,n=resourceSet.create({uri:i.name});n.parse(t,Ecore.XMI),resourceSet.trigger("change")}};var o=i.slice(0,i.size);n.readAsBinaryString(o)}function handleDragOver(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}var EReferenceConnection=DG.Connection.extend({attr:{stroke:"black","stroke-width":1},end:{type:"basic"},initialize:function(e){e&&e.model&&(this.model=e.model)}}),ESuperTypesConnection=DG.Connection.extend({attr:{stroke:"black","stroke-width":1},end:{fill:"white",type:"basic"},initialize:function(){}}),CompartmentFigure={type:"rect",width:100,height:20,fill:"#fff",stroke:"#86A4D0","stroke-width":1},FeatureCompartment=DG.Shape.extend({config:{},initialize:function(){this.layout=new DG.GridLayout(this,{columns:1,vgap:5,hgap:5,marginHeight:5,marginWidth:5}),this.on("click",this.addFeature)},createFigure:function(){return DG.Figure.create(this,CompartmentFigure)},addFeature:function(){var e,t=Workbench.palette,i=t.selected;i&&"EAttribute"===i.title&&(e=new i.shape,this.add(e),this.diagram().render(),t.selected=null)}}),OperationCompartment=DG.Shape.extend({config:{},initialize:function(){this.layout=new DG.GridLayout(this,{columns:1,vgap:5,hgap:5,marginHeight:5,marginWidth:5}),this.on("click",this.addFeature)},createFigure:function(){return DG.Figure.create(this,CompartmentFigure)},addFeature:function(){var e,t=Workbench.palette,i=t.selected;i&&"EOperation"===i.title&&(e=new i.shape,this.add(e),this.diagram().render(),t.selected=null)}}),EAttributeShape=DG.Label.extend({initialize:function(e){var t=e||{};this.model=t.model?t.model:Ecore.EAttribute.create({name:"name",eType:Ecore.EString});var i=this.model.get("name");this.model.has("eType")&&(i+=": "+this.model.get("eType").get("name")),this.attributes.text=i},createFigure:function(){return DG.Figure.create(this,{type:"text",text:"name: String",stroke:"none",fill:"#535353"})}}),ClassifierLabel={type:"text",text:"","font-size":14,"font-weight":"bold",height:30},ClassifierShape={type:"rect",width:100,height:60,fill:"#D3DAEE",opacity:1,stroke:"#86A4D0","stroke-width":1,"stroke-opacity":.8},ClassifierLayout={type:"grid",columns:1},ClassLabelShape=DG.Label.extend({config:{draggable:!1,resizable:!1,selectable:!1,editable:!0},createFigure:function(){return DG.Figure.create(this,ClassifierLabel)}}),ClassLabelCompartment=DG.Shape.extend({config:{},initialize:function(){this.layout=new DG.GridLayout(this,{columns:1,vgap:5,hgap:5,marginHeight:5,marginWidth:5})},createFigure:function(){return DG.Figure.create(this,_.extend({},CompartmentFigure,{fill:"none"}))}}),EClassShape=DG.Shape.extend({anchors:[{position:"n",connectionType:ESuperTypesConnection},{position:"e",connectionType:EReferenceConnection}],initialize:function(e){var t=e||{},i=t.diagram;t.model?(this.model=e.model,this.model.shape=this):(this.model=Ecore.EClass.create({name:"MyClass"}),this.model.shape=this,i.model.get("eClassifiers").add(this.model)),this.layout=new DG.GridLayout(this,{columns:1}),this.add(new ClassLabelCompartment),this.add(new FeatureCompartment),this.add(new OperationCompartment),this.children[0].gridData=new DG.GridData({horizontalAlignment:"fill",grabExcessHorizontalSpace:!0}),this.children[1].gridData=new DG.GridData({horizontalAlignment:"fill",grabExcessHorizontalSpace:!0}),this.children[2].gridData=new DG.GridData({horizontalAlignment:"fill",grabExcessHorizontalSpace:!0,grabExcessVerticalSpace:!0}),this.children[0].add(new ClassLabelShape({text:this.model.get("name")})),this.createContent(i)},createFigure:function(){return DG.Figure.create(this,{type:"rect",width:100,height:60,fill:"#D3DAEE",cursor:"move",stroke:"#86A4D0","stroke-width":1})},createContent:function(){_.each(this.model.get("eAttributes"),function(e){this.children[1].add(new EAttributeShape({model:e}))},this)}}),layout=function(){var e={x:0,y:100};return function(){var t=10,i=800,n=150;return i>e.x+n?(e.x=e.x+n,e.y=e.y):(e.x=t,e.y=e.y+n),e}},EcoreDiagram=DG.Diagram.extend({initialize:function(e){var t=e||{};this.layout=layout(),t.model&&(this.model=t.model,this.createContent()),this.wrapper.on("click",this.addFromPalette(this))},addFromPalette:function(e){return function(t){var i,n,o=Workbench.palette,a=o.selected;a&&"function"==typeof a.shape&&(n=DG.Point.get(t),n.diagram=e,i=new a.shape(n),e.add(i),e.render(),o.selected=null)}},createContent:function(){this.model.get("eClassifiers").each(function(e){if(e.isTypeOf("EClass")){var t=this.layout(),i=new EClassShape({diagram:this,model:e,x:t.x,y:t.y});this.add(i)}},this)}}),NavBox=Backbone.View.extend({template:_.template('<div class="nav-box"></div>'),templateHeader:_.template('<div class="nav-box-header"><%= title %><i class="icon-large"></i></div>'),_icon_up:"icon-double-angle-up",_icon_down:"icon-double-angle-down",events:{"click .icon-double-angle-up":"hide","click .icon-double-angle-down":"show"},initialize:function(e){this.navigator=e.navigator,this.views=[],this.isRender=!1},render:function(){if(this.isRender)return this;var e=this.template(),t=this.templateHeader({title:this.title});return this.setElement(e),this.$el.append(t),$('i[class~="icon-large"]',this.$el).addClass(this._icon_up),this.isRender=!0,this},show:function(){_.each(this.views,function(e){this.$el.append(e.render().$el)},this),$('i[class~="'+this._icon_down+'"]',this.$el).removeClass(this._icon_down).addClass(this._icon_up)},hide:function(){_.each(this.views,function(e){e.remove()}),$('i[class~="'+this._icon_up+'"]',this.$el).removeClass(this._icon_up).addClass(this._icon_down)},removeView:function(e){e.remove()},removeViews:function(){_.each(this.views,this.removeView)},remove:function(){return this.removeViews(),this.views.length=0,Backbone.View.prototype.remove.apply(this)}}),NavigatorHeaderView=Backbone.View.extend({template:_.template('<div class="nav-header"><div class="nav-header-content"></div></div>'),templateHide:_.template('<i class="icon-double-angle-left icon-large"></i>'),templateShow:_.template('<i class="icon-double-angle-right icon-large"></i>'),events:{"click .icon-double-angle-left":"hide","click .icon-double-angle-right":"show"},initialize:function(){_.bindAll(this)},render:function(e){this.$el&&this.remove();var t=this.template();this.setElement(t);var i,n=$(".nav-header-content",this.$el);return e?(i=this.templateShow(),n.append(i)):(i=this.templateHide(),n.append(i)),this},hide:function(){this.trigger("hide")},show:function(){this.trigger("show")}}),PaletteView=NavBox.extend({title:"Palette",shapes:{EClass:EClassShape,EAttribute:EAttributeShape},connections:{},initialize:function(e){_.bindAll(this),NavBox.prototype.initialize.apply(this,[e])},render:function(){return NavBox.prototype.render.apply(this),_.each(this.shapes,function(e,t){var i=new PaletteItemView({palette:this,shape:e,title:t});this.views.push(i),this.$el.append(i.render().$el)},this),_.each(this.connections,function(e,t){var i=new PaletteItemView({palette:this,connection:e,title:t});this.views.push(i),this.$el.append(i.render().$el)},this),this}}),PaletteHeaderView=Backbone.View.extend({template:'<div class="nav-row"></div>',initialize:function(e){this.palette=e.palette},render:function(){return this.setElement(this.template),console.log(this.$el),this.selectTool=new ToolItemView({palette:this.palette,title:"select",icon:"icon-arrow"}),this.selectTool.render(),this.$el.append(this.selectTool.$el),this}}),PaletteItemView=Backbone.View.extend({template:_.template('<div class="nav-row"><i class="icon-edit-<%= title %>"></i><span><%= title %></span></div>'),events:{click:"select"},initialize:function(e){_.bindAll(this),this.palette=e.palette,this.shape=e.shape,this.connection=e.connection,this.title=e.title},render:function(){var e=this.template({title:this.title});return this.setElement(e),this},select:function(){this.palette.selected=this}}),ToolItemView=PaletteItemView.extend({template:_.template('<i class="<%= icon %>"></i><span><%= title %></span>'),initialize:function(e){PaletteItemView.prototype.initialize.apply(this,[e]),this.icon=e.icon},render:function(){return this.setElement(this.template({title:this.title,icon:this.icon})),this}}),ResourceSetView=NavBox.extend({title:"Resources",initialize:function(e){_.bindAll(this,"show","hide"),NavBox.prototype.initialize.apply(this,[e]),this.modal=new CreateResourceModal({model:this.model}),this.model.on("change add remove",this.render)},render:function(){NavBox.prototype.render.apply(this),this.model.get("resources").each(this.addResource,this);var e=(new ResourceView).render();return this.views.push(e),this.$el.append(e.$el),_.each(this.views,function(e){e.on("create",this.createResource,this),e.on("open:editor",function(){this.navigator.trigger("open:editor",e.model)},this),e.on("remove",this.deleteResource,this)},this),this},addResource:function(e){var t=new ResourceView({model:e});return t.render(),this.views.push(t),this.$el.append(t.$el),this},deleteResource:function(){},createResource:function(){this.modal.render().show()}}),ResourceView=Backbone.View.extend({template:'<div class="nav-row"></div>',templateResource:_.template('<i class="<%= icon1 %>"></i><span> <%= uri %></span><i class="<%= icon2 %>""></i>'),templateAdd:_.template('<i class="<%= icon4 %>"></i>'),events:{click:"openEditor","click .icon-remove":"remove","click .icon-plus":"createResource"},icons:[{klass:"icon-folder-close icon-large"},{klass:"icon-remove icon-large",tooltip:"Delete this resource"},{klass:"icon-plus icon-large",tooltip:"Create a new resource"}],initialize:function(){_.bindAll(this)},render:function(){if(this.setElement(this.template),this.model){var e=this.model.get("uri"),t=e.lastIndexOf("/");e=t?e.substring(t+1,e.length):e,this.$el.children().remove(),this.$el.append(this.templateResource({icon1:this.icons[0].klass,icon2:this.icons[1].klass,uri:e}))}else this.$el.children().remove(),this.$el.append(this.templateAdd({icon4:this.icons[2].klass}));return this.addTooltip(),this},addTooltip:function(){_.each(this.icons,function(e){var t=$('i[class="'+e.klass+'"]',this.$el);t.length&&e.tooltip&&t.tooltip({placement:"right",title:e.tooltip,trigger:"hover"})},this)},openEditor:function(e){e&&e.stopPropagation(),this.model&&this.trigger("open:editor",this.model)},createResource:function(){this.trigger("create",this)},remove:function(){return this.trigger("remove",this.model),Backbone.View.prototype.remove.apply(this)}}),PropertyView=NavBox.extend({title:"Properties",initialize:function(e){NavBox.prototype.initialize.apply(this,[e])},render:function(){return NavBox.prototype.render.apply(this),this.update(),_.each(this.views,this.renderView,this),this},update:function(){this.removeViews(),this.views.length=0;var e=this.model;if(e){var t=function(e){return!e.get("many")&&!e.get("derived")},i=_.filter(e.eClass.get("eAllAttributes"),t);i=_.union(i,_.filter(e.eClass.get("eAllReferences"),function(e){return!e.get("containment")&&!e.get("derived")}));var n,o;this.views=_.flatten(_.map(i,function(t){return t.get("eType")===Ecore.EBoolean?new BooleanView({model:e,attribute:t}):t.isTypeOf("EAttribute")?(n=new LabelView({model:t.get("name")}),o=new TextView({model:e,attribute:t}),[n,o]):t.get("many")?n=new LabelView({model:t.get("name")}):(n=new LabelView({model:t.get("name")}),o=new SingleSelectView({model:e,reference:t}),[n,o])}))}else this.views=[]},renderView:function(e){var t=e.render().$el;this.$el.append(t)}}),RowView=Backbone.View.extend({template:'<div class="nav-row"></div>',render:function(){return this.setElement(this.template),this}}),LabelView=RowView.extend({labelTmpl:_.template('<label class="label-property"><%= text %></label>'),initialize:function(){},render:function(){return RowView.prototype.render.apply(this),this.$el.append(this.labelTmpl({text:this.model})),this}}),TextView=RowView.extend({textTmpl:_.template('<div class="text-property" contenteditable=""><%= text %></div>'),initialize:function(e){this.attribute=e.attribute},render:function(){return RowView.prototype.render.apply(this),this.$el.append(this.textTmpl({text:this.model.get(this.attribute)})),this}}),BooleanView=RowView.extend({boolTmpl:_.template('<div class="bool-property"><label><input type="checkbox" <% if (value) { %> checked <% } %> ><%= label %></label></div>'),initialize:function(e){this.attribute=e.attribute},render:function(){RowView.prototype.render.apply(this);var e=this.model.get(this.attribute)===!0?!0:!1;return this.$el.append(this.boolTmpl({label:this.attribute.get("name"),value:e})),this}}),SingleSelectView=RowView.extend({selectTmpl:_.template("<select></select>"),initialize:function(e){this.reference=e.reference},render:function(){return RowView.prototype.render.apply(this),this.$el.append(this.selectTmpl({})),this}}),NavigatorView=Backbone.View.extend({el:"#navigator",initialize:function(){_.bindAll(this),this.resourceSetView=new ResourceSetView({model:this.model,navigator:this}),this.paletteView=new PaletteView({navigator:this}),this.propertyView=new PropertyView({navigator:this}),this.header=new NavigatorHeaderView,this.header.on("hide",this.hide),this.header.on("show",this.show)},render:function(){return this.$header=this.header.render().$el,this.$el.append(this.$header),this.$el.append(this.resourceSetView.render().$el),this.$el.append(this.paletteView.render().$el),this.$el.append(this.propertyView.render().$el),this},hide:function(){this.trigger("hide"),this.resourceSetView.remove(),this.paletteView.remove(),this.propertyView.remove(),this.$header=this.header.render(!0).$el,this.$el.append(this.$header),this.$el.animate({width:"30px"},200)},show:function(){this.trigger("show"),this.$el.animate({width:"280px"},200),this.render()}}),ModalView=Backbone.View.extend({template:_.template('<div id="<%= id =>" class="modal hide fade"></div>'),templateHeader:_.template('<div class="modal-header"></div>'),templateBody:_.template('<div class="modal-body"></div>'),templateFooter:_.template('<div class="modal-footer"><a href="#" class="btn mclose">Close</a><a href="#" class="btn confirm">Confirm</a></div>'),render:function(){var e=this.template({id:this.cid}),t=this.templateHeader(),i=this.templateBody(),n=this.templateFooter();return this.setElement(e),this.$el.append(t),this.$el.append(i),this.$el.append(n),this.$header=$('div[class="modal-header"]',this.$el),this.$body=$('div[class="modal-body"]',this.$el),this.$footer=$('div[class="modal-footer"]',this.$el),this},show:function(){this.$el.modal("show")},hide:function(){this.$el.modal("hide")}}),CreateResourceModal=ModalView.extend({templateForm:_.template('<form class="form-horizontal"></form>'),templateControlURI:_.template('<div class="control-group"><label class="control-label" for="inputURI">URI</label><div class="controls"><input type="text" id="inputURI" placeholder="URI"></div></div>'),templateControlElement:_.template('<div class="control-group"><label class="control-label" for="inputElement">Element</label><div class="controls"><select type="text" id="selectElement"></select></div>'),templateHeaderContent:_.template('<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h3>Create Resource</h3></div>'),templateOptions:_.template('<% _.each(options, function(option) { %> <option><%= option.get("name") %></option> <% }); %>'),events:{'click .modal-footer a[class~="confirm"]':"onConfirm",'click .modal-footer a[class~="mclose"]':"onClose"},initialize:function(){_.bindAll(this,"onConfirm")},render:function(){ModalView.prototype.render.apply(this);var e=this.templateForm(),t=this.templateHeaderContent(),i=this.templateControlURI(),n=this.templateControlElement();this.$header.append(t),this.$body.append(e),this.$form=$("form",this.$body),this.$form.append(i).append(n),this.$select=$("#selectElement",this.$form),this.classes=this.model.elements("EClass"),this.classes=_.filter(this.classes,function(e){return!e.get("abstract")});var o=this.templateOptions({options:this.classes});return this.$select.append(o),this},createResource:function(e,t){var i=this.model.create({uri:e});i.get("contents").add(t.create()),this.model.trigger("change add",i)},onClose:function(){this.hide()},onConfirm:function(){var e=$("#inputURI",this.$form).val(),t=$("option:selected",this.$select).val();if(e&&e.length&&t){var i=_.find(this.classes,function(e){return e.get("name")===t});i&&this.createResource(e,i)}this.$el.modal("hide")}}),PropertyWindow=Ecore.Edit.Window.extend({el:"#property-window",title:"Property",draggable:!0,content:new Ecore.Edit.PropertySheet,render:function(){return this.content.model=this.model,Ecore.Edit.Window.prototype.render.apply(this)}}),DiagramPanelPart=Ecore.Edit.PanelPart.extend({tmpl:_.template('<div id="diagram-<%= id %>" style="width: 100%; height: 100%;"></div>'),initialize:function(){},renderContent:function(){this.$diagram||(this.$diagram=$(this.tmpl({id:this.cid})),this.$content.append(this.$diagram)),this.diagram||(this.diagram=new EcoreDiagram(this.$diagram[0],{model:this.model.get("contents").first()}))}}),MultiPartEditor=Ecore.Edit.MultiPanelElement.extend({initialize:function(){this.title=Ecore.Edit.util.lastSegment(this.model.get("uri")),this.tab=new Ecore.Edit.TabDropdown({title:this.title,editor:this});var e=new Ecore.Edit.TreePanelPart({model:this.model}),t=new DiagramPanelPart({model:this.model});this.tab.addDropItem("Tree Editor",e.cid),this.tab.addDropItem("Diagram Editor",t.cid,function(){t.diagram.render()});var i=this.tab;this.tab.addDropItem("Close",function(){i.remove()}),this.parts=[e,t],this.tab.on("remove",this.remove,this),this.parts[0].tree.on("select",function(e){this.trigger("select",e)},this),this.parts[0].tree.on("deselect",function(e){this.trigger("deselect",e)},this)}}),EcoreTabPanel=Ecore.Edit.TabPanel.extend({el:"#main2",open:function(e){var t=this.find(e);t||(t=new MultiPartEditor({model:e}),this.add(t),t.on("select",function(e){this.trigger("select",e)},this),t.on("deselect",function(e){this.trigger("deselect",e)},this),t.render()),this.show(t),t.diagram&&t.diagram.render()},find:function(e){return _.find(this.elements,function(t){return t.model===e})},expand:function(){this.$el[0].style.left="20px"}}),dropzone=$("#navigator")[0];dropzone&&(dropzone.addEventListener("dragover",handleDragOver,!1),dropzone.addEventListener("drop",handleFileSelect,!1));var resourceSet=Ecore.ResourceSet.create(),EcoreResource=resourceSet.create({uri:Ecore.EcorePackage.get("nsURI")}),ResourceResource=resourceSet.create({uri:"http://www.eclipselabs.org/ecore/2012/resources"}),SampleResource=resourceSet.create({uri:"sample.ecore"}),SamplePackage=Ecore.EPackage.create({name:"sample",nsPrefix:"sample",nsURI:"http://example.org/sample",eClassifiers:[{eClass:Ecore.EClass,name:"Foo",eStructuralFeatures:[{eClass:Ecore.EAttribute,name:"bar",eType:Ecore.EString}]}]});SampleResource.get("contents").add(SamplePackage),window.Workbench=_.extend({},Backbone.Events),Workbench.properties=new PropertyWindow,Workbench.editorTab=new EcoreTabPanel,Workbench.navigator=new NavigatorView({model:resourceSet}),Workbench.palette=Workbench.navigator.paletteView,window.onload=function(){Workbench.navigator.render(),Workbench.navigator.on("open:editor",function(e){this.editorTab.render().open(e)},Workbench),Workbench.navigator.on("open:diagram",function(e){this.editorTab.render().open(e,!0)},Workbench),Workbench.navigator.on("hide",function(){$("#main2").animate({left:"30px"},200)},Workbench),Workbench.navigator.on("show",function(){$("#main2").animate({left:"280px"},200)},Workbench),Workbench.editorTab.on("select",function(e){this.navigator.propertyView.model=e.model,this.navigator.propertyView.render()},Workbench),Workbench.properties.content.on("change",function(){console.log(Workbench.editorTab)},Workbench),resourceSet.on("add",function(e){this.editorTab.render().open(e),this.properties.content.model=e,this.properties.render()},Workbench)};